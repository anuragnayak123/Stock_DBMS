
CREATE TABLE USERS(
    NAME VARCHAR2(50),
    DOB DATE,
    USER_ID NUMBER(20) PRIMARY KEY,
    PASSWORD VARCHAR2(50),
    TYPE VARCHAR2(50),
    EMAIL_ID VARCHAR2(50)
);

CREATE TABLE USER_PHONE_NO(
    PHONE_NO NUMBER(20),
    USER_ID NUMBER(20) REFERENCES USERS(USER_ID),
    PRIMARY KEY (PHONE_NO,USER_ID)
);

CREATE TABLE ADMINS(
    STAFF_NO NUMBER(20) PRIMARY KEY,
    USER_ID NUMBER(20)  REFERENCES USERS(USER_ID)
);

CREATE TABLE BROKER(
    LISCENSE_NO NUMBER(20) PRIMARY KEY,
    USER_ID NUMBER(20) REFERENCES USERS(USER_ID),
    CUSTOMER_NO NUMBER(20) REFERENCES CUSTOMER(CUSTOMER_NO)
);

CREATE TABLE CUSTOMER(
    CUSTOMER_NO NUMBER(20) PRIMARY KEY,
    USER_ID NUMBER(20) REFERENCES USERS(USER_ID),
    PORTFOLIO_ID NUMBER(20) REFERENCES PORTFOLIO(PORTFOLIO_ID)
);

CREATE TABLE PORTFOLIO(
    PORTFOLIO_ID NUMBER(20) PRIMARY KEY,
    EARNING NUMBER(20),
    ORDER_ID NUMBER(20) REFERENCES ORDERS(ORDER_ID)
);

CREATE TABLE ORDERS(
ORDER_ID NUMBER(20) PRIMARY KEY,
PRICE NUMBER(20),
QUANTITY NUMBER(20),
ORDER_TYPE VARCHAR2(50),
ORDER_TIME TIMESTAMP
);

CREATE TABLE STOCKS(
TICKER VARCHAR2(50) PRIMARY KEY,
UNIT_PRICE NUMBER(20,5),
UPDATE_TIME TIMESTAMP,
STOCKS_FLOAT NUMBER(20),
ORDER_ID NUMBER(20),
FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID)
);

CREATE TABLE STOCKS_LISTED_IN(
LISTED_IN VARCHAR2(50),
TICKER VARCHAR2(50),
PRIMARY KEY(LISTED_IN,TICKER),
FOREIGN KEY (TICKER) REFERENCES STOCKS(TICKER)
);

CREATE TABLE STOCKS_INDICES(
STOCK_INDEX VARCHAR2(50),
TICKER VARCHAR2(50),
PRIMARY KEY(STOCK_INDEX,TICKER),
FOREIGN KEY (TICKER) REFERENCES STOCKS(TICKER)
);

CREATE TABLE TECHNICALS(
STOCK_ID NUMBER(20) PRIMARY KEY,
PRICE_HIGH NUMBER(20,5),
PRICE_LOW NUMBER(20,5),
PRICE_OPEN NUMBER(20,5),
PRICE_CLOSE NUMBER(20,5),
TICKER VARCHAR2(50),
FOREIGN KEY (TICKER) REFERENCES STOCKS(TICKER)
);

CREATE TABLE CONTAINS(
    PORTFOLIO_ID NUMBER(20) REFERENCES PORTFOLIO(PORTFOLIO_ID) ,
    TICKER VARCHAR2(50) REFERENCES STOCKS(TICKER),
    QUANTITY NUMBER(20),
    PRIMARY KEY(PORTFOLIO_ID,TICKER)
);

CREATE TABLE FUNDAMENTALS (
    CORP_ID   NUMBER(20) PRIMARY KEY,
    PE_RATIO  NUMBER(20, 5),
    PB_RATIO  NUMBER(20, 5),
    DIV_YIELD NUMBER(20, 5),
    REVENUE   NUMBER(20, 5),
    PROFIT    NUMBER(20, 5)
);

CREATE TABLE company (
    reg_no       NUMBER(20) PRIMARY KEY,
    company_name VARCHAR2(50),
    headquarters VARCHAR2(50),
    ticker       VARCHAR2(50),
    corp_id      NUMBER(20),
    FOREIGN KEY ( ticker )
        REFERENCES stocks ( ticker ),
    FOREIGN KEY ( corp_id )
        REFERENCES fundamentals ( corp_id )
);

CREATE TABLE holders (
    reg_no       NUMBER(20) PRIMARY KEY,
    promoter     NUMBER(20, 5),
    mutual_fund  NUMBER(20, 5),
    domestic_ins NUMBER(20, 5),
    foreign_ins  NUMBER(20, 5),
    retail       NUMBER(20, 5),
    FOREIGN KEY ( reg_no )
        REFERENCES company ( reg_no )
);

CREATE TABLE sector (
    sector_name    VARCHAR2(50),
    sector_pe      NUMBER(20, 5),
    sector_pb      NUMBER(20, 5),
    sector_div_yld NUMBER(20, 5),
    reg_no         NUMBER(20),
    primary key (sector_name,reg_no),
    FOREIGN KEY ( reg_no )
        REFERENCES company ( reg_no )
);

CREATE TABLE company_helpline (
    helpline NUMBER(20),
    reg_no   NUMBER(20),
    PRIMARY KEY ( helpline,
                  reg_no ),
    FOREIGN KEY ( reg_no )
        REFERENCES company ( reg_no )
);

------------------------INSERTIONS--------------------

--USERS:
INSERT INTO USERS VALUES('John',TO_DATE('1990-01-01','YYYY-MM-DD'),001,'1234','Customer','john@example.com');
INSERT INTO USERS VALUES('Steve',TO_DATE('1970-04-05','YYYY-MM-DD'),003,'efgh','Admin','steve@example.com');
INSERT INTO USERS VALUES('Mary',TO_DATE('1980-02-03','YYYY-MM-DD'),002,'abcd','Broker','mary@example.com');
INSERT INTO USERS VALUES('Richard',TO_DATE('1960-07-09','YYYY-MM-DD'),004,'ijkl','Customer','richard@example.com');
INSERT INTO USERS VALUES('Mark',TO_DATE('1950-08-11','YYYY-MM-DD'),005,'mnop','Customer','mark@example.com');
INSERT INTO USERS VALUES('Jane Smith', TO_DATE('1995-05-05','YYYY-MM-DD'), 013, 'pksf923', 'Broker', 'jane.smith@example.com');
INSERT INTO USERS VALUES('Robert Johnson', TO_DATE('1985-12-31', 'YYYY-MM-DD'), 024, 'pvrm163', 'Broker', 'robert.johnson@example.com');
INSERT INTO USERS VALUES('Emily Davis', TO_DATE('1992-03-15', 'YYYY-MM-DD'), 035, 'pasl1e33', 'Broker', 'emily.davis@example.com');
INSERT INTO USERS VALUES('William Brown', TO_DATE('1998-07-20', 'YYYY-MM-DD'), 046, 'pasf23', 'Broker', 'william.brown@example.com');
INSERT INTO USERS VALUES('Anurag Nayak', TO_DATE('1997-07-10', 'YYYY-MM-DD'), 069, 'paef23', 'Customer', 'anurag@example.com');
INSERT INTO USERS VALUES('Kapardhi', TO_DATE('1996-08-24', 'YYYY-MM-DD'), 073, 'pasft3', 'Customer', 'kappa@example.com');

SELECT * FROM USERS;

--USER_PHONE_NO:
INSERT INTO USER_PHONE_NO VALUES(1234567890,001);
INSERT INTO USER_PHONE_NO VALUES(2345678901,002);
INSERT INTO USER_PHONE_NO VALUES(3456789012,003);
INSERT INTO USER_PHONE_NO VALUES(4567890123,004);
INSERT INTO USER_PHONE_NO VALUES(5678901234,005);
INSERT INTO USER_PHONE_NO VALUES(6789012345,013);
INSERT INTO USER_PHONE_NO VALUES(7890123456,013);
INSERT INTO USER_PHONE_NO VALUES(8901234567,024);
INSERT INTO USER_PHONE_NO VALUES(9012345678,024);
INSERT INTO USER_PHONE_NO VALUES(1234567890,035);
INSERT INTO USER_PHONE_NO VALUES(2345678901,035);
INSERT INTO USER_PHONE_NO VALUES(3456789012,046);
INSERT INTO USER_PHONE_NO VALUES(4567890123,046);
INSERT INTO USER_PHONE_NO VALUES(5678901234,046);


SELECT * FROM USER_PHONE_NO;

--ADMINS:
INSERT INTO ADMINS VALUES(01, 003);

SELECT * FROM ADMINS;

--BROKER:
INSERT INTO BROKER VALUES(10001,002,20001);
INSERT INTO BROKER VALUES(10002,013,20002);
INSERT INTO BROKER VALUES(10003,024,20003);
INSERT INTO BROKER VALUES(10004,035,20004);
INSERT INTO BROKER VALUES(10005,046,20005);

SELECT * FROM BROKER;

--CUSTOMER:
INSERT INTO CUSTOMER VALUES(20001,001,30001);
INSERT INTO CUSTOMER VALUES(20002,004,30002);
INSERT INTO CUSTOMER VALUES(20003,005,30003);
INSERT INTO CUSTOMER VALUES(20004,069,30004);
INSERT INTO CUSTOMER VALUES(20005,073,30005);

select * from customer;

--PORTFOLIO:
INSERT INTO PORTFOLIO VALUES(30001,100000,40001);
INSERT INTO PORTFOLIO VALUES(30002,200000,40002);
INSERT INTO PORTFOLIO VALUES(30003,300000,40003);
INSERT INTO PORTFOLIO VALUES(30004,200000,40004);
INSERT INTO PORTFOLIO VALUES(30005,500000,40005);

select * from portfolio;

--ORDERS:
INSERT INTO ORDERS VALUES(40001,1000,10,'BUY',TO_TIMESTAMP('2020-01-01 09:30:00','YYYY-MM-DD HH24:MI:SS'));
INSERT INTO ORDERS VALUES(40002,1500,20,'SELL',TO_TIMESTAMP('2020-02-02 10:30:00','YYYY-MM-DD HH24:MI:SS'));
INSERT INTO ORDERS VALUES(40003,2000,30,'BUY',TO_TIMESTAMP('2020-03-03 11:30:00','YYYY-MM-DD HH24:MI:SS'));
INSERT INTO ORDERS VALUES(40004,2500,40,'SELL',TO_TIMESTAMP('2020-04-04 12:30:00','YYYY-MM-DD HH24:MI:SS'));
INSERT INTO ORDERS VALUES(40005,3000,50,'BUY',TO_TIMESTAMP('2020-05-05 13:30:00','YYYY-MM-DD HH24:MI:SS'));

select * from orders;

--STOCKS:
INSERT INTO STOCKS VALUES('AAPL',125.50,TO_TIMESTAMP('2020-01-01 09:30:00','YYYY-MM-DD HH24:MI:SS'),1000,40001);
INSERT INTO STOCKS VALUES('MSFT',110.20,TO_TIMESTAMP('2020-02-02 10:30:00','YYYY-MM-DD HH24:MI:SS'),1500,40002);
INSERT INTO STOCKS VALUES('AMZN',1790.23,TO_TIMESTAMP('2020-03-03 11:30:00','YYYY-MM-DD HH24:MI:SS'),2000,40003);
INSERT INTO STOCKS VALUES('FB',195.32,TO_TIMESTAMP('2020-04-04 12:30:00','YYYY-MM-DD HH24:MI:SS'),2500,40004);
INSERT INTO STOCKS VALUES('GOOGL',1280.39,TO_TIMESTAMP('2020-05-05 13:30:00','YYYY-MM-DD HH24:MI:SS'),3000,40005);

select * from stocks;

--STOCKS_LISTED_IN:
INSERT INTO STOCKS_LISTED_IN VALUES('NASDAQ','AAPL');
INSERT INTO STOCKS_LISTED_IN VALUES('NYSE','MSFT');
INSERT INTO STOCKS_LISTED_IN VALUES('NASDAQ','AMZN');
INSERT INTO STOCKS_LISTED_IN VALUES('NYSE','FB');
INSERT INTO STOCKS_LISTED_IN VALUES('NASDAQ','GOOGL');

select * from stocks_listed_in;

--STOCKS_INDICES:
INSERT INTO STOCKS_INDICES VALUES('NASDAQ 100','AAPL');
INSERT INTO STOCKS_INDICES VALUES('NYSE 100','MSFT');
INSERT INTO STOCKS_INDICES VALUES('NASDAQ 100','AMZN');
INSERT INTO STOCKS_INDICES VALUES('NYSE 100','FB');
INSERT INTO STOCKS_INDICES VALUES('NASDAQ 100','GOOGL');

select * from stocks_indices;

--TECHNICALS:
INSERT INTO TECHNICALS VALUES(1,130.65,120.23,125.53,126.12,'AAPL');
INSERT INTO TECHNICALS VALUES(2,115.34,105.62,110.43,109.34,'MSFT');
INSERT INTO TECHNICALS VALUES(3,1800.31,1730.23,1770.23,1771.24,'AMZN');
INSERT INTO TECHNICALS VALUES(4,200.43,190.65,199.12,199.54,'FB');
INSERT INTO TECHNICALS VALUES(5,1290.65,1250.65,1280.72,1282.39,'GOOGL');

select * from technicals;

--CONTAINS:
INSERT INTO CONTAINS VALUES(30001,'AAPL',100);
INSERT INTO CONTAINS VALUES(30002,'MSFT',100);
INSERT INTO CONTAINS VALUES(30003,'AMZN',50);
INSERT INTO CONTAINS VALUES(30004,'FB',200);
INSERT INTO CONTAINS VALUES(30005,'GOOGL',150);

select * from contains;

--FUNDAMENTALS:
INSERT INTO FUNDAMENTALS VALUES(1,3.45,8.23,2.43,10000,2000);
INSERT INTO FUNDAMENTALS VALUES(2,2.43,6.32,1.5,20000,5000);
INSERT INTO FUNDAMENTALS VALUES(3,5.54,1.23,0.23,30000,10000);
INSERT INTO FUNDAMENTALS VALUES(4,4.23,1.63,1.45,40000,15000);
INSERT INTO FUNDAMENTALS VALUES(5,3.45,5.32,2.5,50000,20000);

select * from fundamentals;

--COMPANY:
INSERT INTO COMPANY VALUES(1,'Apple Inc','Cupertino','AAPL',1);
INSERT INTO COMPANY VALUES(2,'Microsoft Corp','Redmond','MSFT',2);
INSERT INTO COMPANY VALUES(3,'Amazon Inc','Seattle','AMZN',3);
INSERT INTO COMPANY VALUES(4,'Facebook Inc','Menlo Park','FB',4);
INSERT INTO COMPANY VALUES(5,'Alphabet Inc','Mountain View','GOOGL',5);

select * from company;

--HOLDERS:
INSERT INTO HOLDERS VALUES (1, 50.00, 25.00, 10.00, 10.00, 5.00);
INSERT INTO HOLDERS VALUES (2, 60.00, 20.00, 5.00, 10.00, 5.00);
INSERT INTO HOLDERS VALUES (3, 40.00, 15.00, 25.00, 10.00, 10.00);
INSERT INTO HOLDERS VALUES (4, 45.00, 10.00, 20.00, 15.00, 10.00);
INSERT INTO HOLDERS VALUES (5, 55.00, 5.00, 20.00, 15.00, 5.00);

select * from holders;

--SECTOR:
INSERT INTO SECTOR VALUES('Technology',5.34,1.43,1.5,1);
INSERT INTO SECTOR VALUES('Technology',4.53,8.75,1.23,2);
INSERT INTO SECTOR VALUES('Delivery',6.63,1.23,0.43,3);
INSERT INTO SECTOR VALUES('Social media',4.32,1.64,1.25,4);
INSERT INTO SECTOR VALUES('Technology',5.67,6.3,2.3,5);

select * from sector;

--COMPANY_HELPLINE:
INSERT INTO COMPANY_HELPLINE VALUES(444111222,1);
INSERT INTO COMPANY_HELPLINE VALUES(333111222,2);
INSERT INTO COMPANY_HELPLINE VALUES(222111222,3);
INSERT INTO COMPANY_HELPLINE VALUES(111331122,4);
INSERT INTO COMPANY_HELPLINE VALUES(123321123,5);

select * from company_helpline;

SELECT u.NAME, u.EMAIL_ID
FROM USERS u
JOIN BROKER b ON u.USER_ID = b.USER_ID
JOIN USER_PHONE_NO up ON up.USER_ID = b.USER_ID
WHERE up.PHONE_NO LIKE '234%';

Select
    U.Name         As Customer_Name,
    P.Portfolio_Id,
    Sum(P.Earning) As Total_Value
From
         Customer C
    Join Users     U On C.User_Id = U.User_Id
    Join Portfolio P On C.Portfolio_Id = P.Portfolio_Id
Group By
    U.Name,
    P.Portfolio_Id;
    
SELECT
    c.company_name,
    AVG(s.unit_price) AS avg_stock_price
FROM
         company c
    JOIN stocks s ON c.ticker = s.ticker
GROUP BY
    c.company_name;



